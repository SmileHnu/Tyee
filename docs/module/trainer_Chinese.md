# tyee.trainer

`tyee.trainer` 模块是 Tyee 框架的核心训练引擎。它负责接收一个定义好的 `Task`（实验蓝图）和一份配置文件，然后管理从头到尾的整个训练、验证和评估流程。`Trainer` 封装了复杂的循环逻辑、分布式训练、混合精度、日志记录和模型保存等功能，让用户可以专注于 `Task` 的设计。

## `Trainer` 类的核心功能

`Trainer` 类通过一系列方法来编排和执行整个实验。

### 1. 初始化与组件构建 (`__init__` 和 `_init_components`)

- **`__init__(self, cfg, rank, world_size)`**: `Trainer` 的构造函数。它会解析主配置文件 `cfg`，设置训练的总步数/轮数、日志/评估/保存的间隔、是否启用混合精度（fp16）等全局参数。最重要的是，它会根据配置实例化一个 `PRLTask` 对象，该对象定义了实验的具体行为。`rank` 和 `world_size` 参数用于支持分布式训练。

- `_init_components(...)`

  : 在每个训练流程（例如，在交叉验证的每一折）开始时被调用。此方法负责准备所有必要的组件，包括：

  - 创建日志（logger）和 TensorBoard (`SummaryWriter`)。
  - 调用 `Task` 的方法来构建和划分数据集，并创建 `DataLoader`。
  - 调用 `Task` 的方法来构建模型、优化器和学习率调度器。
  - 根据配置设置分布式数据并行（DDP）和混合精度训练的 `GradScaler`。
  - 检查并从指定的检查点（checkpoint）恢复训练状态。

### 2. 主训练循环 (`run` 和 `run_loop`)

- **`run(self)`**: 启动训练流程的公共入口。它会首先从 `Task` 获取数据集的划分（支持交叉验证），然后对每一折（fold）调用 `run_loop` 来执行训练。
- **`run_loop(self)`**: 包含了核心的 `for` 循环，从 `start_step` 迭代到 `total_steps`。它管理着数据迭代器，并在恰当的时机（如每个 epoch 开始/结束时）调用 `Task` 中定义的 `on_...` 钩子函数。

### 3. 训练与评估步骤 (`_train_step` 和 `_eval_step`)

- **`_train_step(...)`**: 执行**单个训练步**。它从数据加载器中获取一个批次的数据，然后调用 `Task` 中用户自定义的 `train_step` 方法来完成模型的前向传播和损失计算。之后，它负责处理反向传播、梯度累积、梯度裁剪、优化器更新和学习率调整等所有底层操作。
- **`_eval_step(...)`**: 执行**一轮完整的评估**（在验证集或测试集上）。它会遍历评估数据加载器的所有数据，对每个批次调用 `Task` 中用户自定义的 `valid_step` 方法，并使用 `MetricEvaluator` 来累积和计算最终的各项评估指标。

### 4. 日志与模型保存

- **`_log_...` 方法**: 负责在训练过程中，按指定间隔将训练损失、学习率、梯度范数以及验证/测试指标等信息打印到控制台，并写入 TensorBoard。
- **`_save_checkpoint(...)` 和 `_check_and_save_best(...)`**: 负责模型的保存。`Trainer` 支持按固定间隔保存最新的检查点，同时也支持根据指定的验证集指标（如 `val_loss` 或 `val_accuracy`）来判断并保存迄今为止性能最佳的模型。